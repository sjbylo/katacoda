# Example of how to allow containers to run as root or any specific user ID.

To allow containers to run as root (or any user) in OpenShift a policy is needed to be set on the _service account_ your pod is running under. 
We will use the _default service account of the project_.

This is the simple Dockerfile we will use.  It simply builds an image and when the image is launched it starts a long running process ``sleep 999999``.

Have a look at the Dockerfile:

``clear; cat build-root/Dockerfile``{{execute}}

First we will see what happens if we try to run a container as root on OpenShift.

---

# Show that containers running on OpenShift cannot run as root (by default).

Before we get started, you need to login and create a project in OpenShift
to work in.

To login to the OpenShift cluster used for this course from the _Terminal_,
run:

``oc login -u developer -p developer``{{execute}}

This will log you in using the credentials:

* **Username:** ``developer``
* **Password:** ``developer``

You should see the output:

```
Login successful.

You don't have any projects. You can try to create a new project, by running

    oc new-project <projectname>
```

To create a new project called ``myproject`` run the command:

``oc new-project myproject``{{execute}}

You should see output similar to:

```
Now using project "myproject" on server "https://172.17.0.41:8443".
...
```

----

Build a new example container in OpenShift using the above example Dockerfile. 
Note that the Dockerfile contains "**USER 0**", i.e. the container should run as root.

Create new build configuration:

``oc new-build --name mypod --binary``{{execute}}

Start the buiuld and view the output:

``oc start-build mypod --from-dir=build-root --follow --wait``{{execute}}

Launch the container:

``oc new-app mypod``{{execute}}

``oc get po``

``POD_ID=$(oc get pods | grep mypod.*Running | awk '{print $1}' | tail -1); echo $POD_ID``{{execute}}

Exec into the container and you will see it is running as non-root (not 0).

``oc exec $POD_ID id``{{execute}}

You can see that the container is running as uid=1000050000 (or similar).  It is not running as root because OpenShift does not allow containers to run as root by default. 

Remote shell into the pod and see who owns the file:

``oc rsh $POD_ID``{{execute}}
``ls -l /tmp/somefile``{{execute}}
``ps -ef``{{execute}}

As you can see, the file belongs to root, but the process is not running as root (UID!=0). Not that when creating container images using Dockerfiles, commands can run as root to do things like install packages and files as root.

Now do the same with plain Docker.  You can see the container is allowed to run as root by default. 

Build the image.

``docker build -t mypod build-root``{{execute}}

Run the container.

``docker run -it -d --name mycontainer mypod``{{execute}}

Check the user id of the container. 

``docker exec mycontainer id``{{execute}}

You should see that it's allowed to run as root, by default.

```
uid=0(root) gid=0(root) groups=0(root)
```

# Allow OpenShift to run containers as any user or root.

To allow OpenShift to run containers as root, log in as cluster admin and run the following:

``oc login -u system:admin``{{execute}}

Change the policy for the default service account to "anyuid"

``oc adm policy add-scc-to-user anyuid -z default -n myproject``{{execute}}

# Other useful commands

# Add authenitcated user group (all users) to the anyuid SCC
# oc adm policy add-scc-to-group anyuid system:authenticated --as system:admin

# Remove authenitcated user group (all users) from the anyuid SCC
# oc adm policy remove-scc-from-group anyuid system:authenticated --as system:admin

oc edit scc anyuid  # verify the change 
```

Now try again to run the container in OpenShift as root.

Let's deploy a fresh container by using the rollout command.

``oc rollout latest mypod``{{execute}}

Again, fetch the pod id

``POD_ID=$(oc get pods | grep mypod.*Running | awk '{print $1}' | tail -1); echo $POD_ID``{{execute}}

Check again which user the container is running as:

``oc exec $POD_ID id``{{execute}}

You should be able to see it's running as root:

```
uid=0(root) gid=0(root) groups=0(root)
```

Repeat the same as above but using a non-root user IDs.  Use the other Dockerfile in the build-user directory. 

``oc start-build mypod --from-dir=build-user --follow --wait``{{execute}}

Note that when the pod is built again, the pod is automatically re-deployed.

``POD_ID=$(oc get pods | grep mypod.*Running | awk '{print $1}' | tail -1); echo $POD_ID``{{execute}}

``oc exec $POD_ID id``{{execute}}

You should be able to see it's running as user 1001 or default.

Explore what else can be done with policies.

``oc adm policy --help``{{execute}}

Here are some of the things you can do:

```
Manage policy on pods and containers:
  add-scc-to-user                 Add users or serviceaccount to a security context constraint
  add-scc-to-group                Add groups to a security context constraint
  remove-scc-from-user            Remove user from scc
  remove-scc-from-group           Remove group from scc
```

